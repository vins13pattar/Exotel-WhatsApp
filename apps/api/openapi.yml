openapi: 3.0.3
info:
  title: Exotel WhatsApp API
  version: 0.2.0
servers:
  - url: http://localhost:4000
paths:
  /api/v1/auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string }
      responses:
        '200': { description: JWT token }
  /api/v1/auth/refresh:
    post:
      summary: Refresh JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token: { type: string }
      responses:
        '200': { description: JWT token }

  /api/v1/credentials:
    get:
      security: [{ bearerAuth: [] }]
      responses: { '200': { description: List credentials } }
    post:
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [label, apiKey, apiToken, subdomain, sid]
              properties:
                label: { type: string }
                apiKey: { type: string }
                apiToken: { type: string }
                subdomain: { type: string }
                sid: { type: string }
                region: { type: string }
      responses: { '201': { description: Created } }

  /api/v1/messages:
    get:
      security: [{ bearerAuth: [] }]
      responses: { '200': { description: List messages } }
    post:
      security: [{ bearerAuth: [] }]
      summary: Send single or bulk WhatsApp messages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  required: [to, type, body, credentialId]
                  properties:
                    to: { type: string }
                    type: { type: string }
                    body: { type: object }
                    credentialId: { type: string }
                    status_callback: { type: string, format: uri }
                    custom_data: {}
                - type: object
                  required: [credentialId, whatsapp]
                  properties:
                    credentialId: { type: string }
                    status_callback: { type: string, format: uri }
                    whatsapp:
                      type: object
                      properties:
                        messages:
                          type: array
                          items: { type: object }
      responses: { '202': { description: Queued } }
  /api/v1/messages/{id}:
    get:
      security: [{ bearerAuth: [] }]
      responses: { '200': { description: Message status } }
    post:
      security: [{ bearerAuth: [] }]
      summary: Cancel queued message
      responses: { '200': { description: Cancelled } }

  /api/v1/templates:
    get:
      security: [{ bearerAuth: [] }]
      summary: List templates (local cache) or set `remote=true` to fetch from Exotel with filters
      parameters:
        - in: query
          name: remote
          schema: { type: string }
        - in: query
          name: credentialId
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: category
          schema: { type: string }
        - in: query
          name: language
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: string }
        - in: query
          name: before
          schema: { type: string }
        - in: query
          name: after
          schema: { type: string }
      responses: { '200': { description: Templates } }
    post:
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, category, language, payload]
              properties:
                name: { type: string }
                category: { type: string }
                language: { type: string }
                payload: { type: object }
                credentialId: { type: string }
      responses: { '201': { description: Created } }
  /api/v1/templates/{id}:
    put:
      security: [{ bearerAuth: [] }]
      summary: Update template and optionally push to Exotel
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                category: { type: string }
                language: { type: string }
                payload: { type: object }
                credentialId: { type: string }
      responses: { '200': { description: Updated } }
  /api/v1/templates/upload-sample:
    post:
      security: [{ bearerAuth: [] }]
      summary: Upload sample media for template approval
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                credentialId: { type: string }
      responses: { '200': { description: Uploaded } }

  /api/v1/onboarding-links:
    get:
      security: [{ bearerAuth: [] }]
      responses: { '200': { description: List links } }
    post:
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                count: { type: integer }
                credentialId: { type: string }
      responses: { '201': { description: Created } }
  /api/v1/onboarding-links/validate:
    get:
      security: [{ bearerAuth: [] }]
      summary: Validate onboarding token with Exotel
      parameters:
        - in: query
          name: token
          required: true
          schema: { type: string }
        - in: query
          name: credentialId
          schema: { type: string }
      responses: { '200': { description: Validation result } }

  /api/v1/webhooks/exotel:
    post:
      summary: Receive Exotel callbacks
      responses: { '200': { description: ok } }
  /api/v1/webhooks/logs:
    get:
      security: [{ bearerAuth: [] }]
      responses: { '200': { description: List events } }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
